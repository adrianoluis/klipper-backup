# This file contains common pin mappings for the BIGTREETECH SKR mini
# E3 v3.0. To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication/USART.

# The "make flash" command does not work on the SKR mini E3. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the SKR
# mini E3 with that SD card.

# See docs/Config_Reference.md for a description of parameters.

[include mainsail.cfg]
[include macros/*.cfg]
[include autotune_tmc.cfg]
[include KAMP_Settings.cfg]

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_17004D001950425938323120-if00
restart_method: command

[include rpi.cfg]

[printer]
kinematics: corexz
max_velocity: 200
max_accel: 1000
max_z_velocity: 50
max_z_accel: 1000
square_corner_velocity: 4.0

[static_digital_output usb_pullup_enable]
pins: !PC13

[idle_timeout]
timeout: 1800

#  Enables support to exclude or cancel individual objects during the printing process.
[exclude_object]

[firmware_retraction]
retract_length: 1.5
retract_speed: 120
unretract_speed: 120

#####################################################################
#   X Stepper Settings
#####################################################################

######
# Motor -XM
# Endstop - X-STOP
###############
[stepper_x]
step_pin: PB13
dir_pin: PB12
enable_pin: !PB14
rotation_distance: 40
full_steps_per_rotation: 200
microsteps: 16
endstop_pin: ^toolhead:PB5
position_endstop: 220
position_min: 0
position_max: 220
homing_speed: 60
homing_retract_dist: 5
homing_positive_dir: True

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
uart_address: 0
run_current: 0.58
stealthchop_threshold: 999999

#####################################################################
#   Y Stepper Settings
#####################################################################

######
# Motor -YM
# Endstop - Y-STOP
###############
[stepper_y]
step_pin: PB10
dir_pin: PB2
enable_pin: !PB11
rotation_distance: 40
full_steps_per_rotation: 200
microsteps: 16
## Ucomment one of the following:
## Switch-based endstop for Y
endstop_pin: ^PC1 
## Sensorless endstop for Y
#endstop_pin: tmc2209_stepper_y:virtual_endstop
#homing_retract_dist: 0 # Uncomment this line too
position_endstop: 0
position_max: 220
homing_speed: 60
homing_positive_dir: False

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
run_current: 0.58
stealthchop_threshold: 999999
## Uncomment if using sensorless Y homing.
#driver_SGTHRS: 120 # tune this once it's working.

#####################################################################
#   Z Stepper Settings
#####################################################################

######
# Motor -ZAM
# Endstop - Z-STOP
###############
[stepper_z]
step_pin: PB0
dir_pin: PC5
enable_pin: !PB1
rotation_distance: 40
full_steps_per_rotation: 200
microsteps: 16
endstop_pin: probe:z_virtual_endstop
position_max: 215
homing_speed: 30
position_min: -3.0

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin: PC10
uart_address: 1
run_current: 0.58
stealthchop_threshold: 999999

#####################################################################
#   Extruder Settings
#####################################################################
[include toolhead.cfg]

#####################################################################
# 	Bed Heater
#####################################################################

######
# BED Connector
###############
[heater_bed]
heater_pin: PC9
##  Validate the following thermistor type to make sure it is correct
##  See https://www.klipper3d.org/Config_Reference.html#common-thermistors for additional options
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC4
min_temp: 0
max_temp: 130
#control: pid
#pid_Kp: 72.291
#pid_Ki: 1.381
#pid_Kd: 946.110

#####################################################################
# 	Fan Control
#####################################################################

######
# Electronics Fan
# FAN1 Connector
###############
[controller_fan my_controller_fan]
pin: PC7 
max_power: 1.00
kick_start_time: 0.200
heater: heater_bed
fan_speed: 0.60

#####################################################################
#   Temperature control
#####################################################################

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100 

#####################################################################
#   Homing and Bed Mesh
#####################################################################
[include eddy.cfg]

[screws_tilt_adjust]
screw1: 29, 2
screw1_name: Front left
screw2: 195, 2
screw2_name: Front right
screw3: 195, 182
screw3_name: Back right
screw4: 29, 182
screw4_name: Back left
screw_thread: CW-M4
horizontal_move_z: 20
speed: 50

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=,      EXP1_2=PB5,
    EXP1_3=PB8,   EXP1_4=PD6,
    EXP1_5=PB9,   EXP1_6=PA15,
    EXP1_7=,      EXP1_8=,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6,   EXP2_2=PA5,
    EXP2_3=PA10,  EXP2_4=,
    EXP2_5=PA9,   EXP2_6=PA7,
    EXP2_7=,      EXP2_8=,
    EXP2_9=<GND>, EXP2_10=

#####################################################################
#   Displays
#####################################################################
#  mini12864 LCD Display
[display]
lcd_type: uc1701
cs_pin: EXP1_3
a0_pin: EXP1_4
rst_pin: EXP1_5
encoder_pins: ^EXP2_5, ^EXP2_3
click_pin: ^!EXP1_2
contrast: 63
spi_software_miso_pin: EXP2_1
spi_software_mosi_pin: EXP2_6
spi_software_sclk_pin: EXP2_2

#  To control Neopixel RGB in mini12864 display
[neopixel fysetc_mini12864]
pin: EXP1_6
chain_count: 3
initial_RED: 0.1
initial_GREEN: 0.5
initial_BLUE: 0.0
color_order: RGB

##  Set RGB values on boot up for each Neopixel. 
##  Index 1 = display, Index 2 and 3 = Knob
[delayed_gcode welcome]
initial_duration: 1
gcode:
    SET_LED LED=fysetc_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
    SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
    SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3 

[include custom_lcd_menu.cfg]

#####################################################################
#   Case Lights
#####################################################################
;[output_pin LIGHTS]
;pin: PA8
;value: 0
;shutdown_value: 0

;[gcode_macro lights_on]
;gcode:
;    SET_PIN PIN=LIGHTS VALUE=1.0

;[gcode_macro lights_off]
;gcode:
;    SET_PIN PIN=LIGHTS VALUE=0.0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 27.405
#*# pid_ki = 3.447
#*# pid_kd = 54.466
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 71.982
#*# pid_ki = 1.300
#*# pid_kd = 996.044
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 16
#*# calibrate =
#*# 	0.050000:3352748.397,0.087500:3350968.056,0.125000:3348894.188,
#*# 	0.175000:3346450.601,0.212500:3344274.391,0.250000:3342228.540,
#*# 	0.287500:3340193.648,0.325000:3338165.952,0.375000:3335712.807,
#*# 	0.412500:3333557.768,0.450000:3331547.821,0.487500:3329702.280,
#*# 	0.525000:3327915.393,0.575000:3325890.986,0.612500:3323991.289,
#*# 	0.650000:3322188.022,0.687500:3320410.659,0.725000:3318732.455,
#*# 	0.775000:3316811.126,0.812500:3315160.264,0.850000:3313448.480,
#*# 	0.887500:3311883.150,0.925000:3310388.839,0.975000:3308615.241,
#*# 	1.012500:3307070.543,1.050000:3305600.300,1.087500:3304209.277,
#*# 	1.125000:3302783.664,1.175000:3301086.522,1.212500:3299581.211,
#*# 	1.250000:3298088.970,1.287500:3296673.675,1.325000:3295325.167,
#*# 	1.375000:3293772.306,1.412500:3292528.741,1.450000:3291388.784,
#*# 	1.487500:3290024.949,1.525000:3288958.860,1.575000:3287525.766,
#*# 	1.612500:3286213.683,1.650000:3284897.264,1.687500:3283625.446,
#*# 	1.725000:3282457.817,1.775000:3281126.980,1.812500:3279903.293,
#*# 	1.850000:3278778.542,1.887500:3277694.079,1.925000:3276610.163,
#*# 	1.975000:3275303.671,2.012500:3274099.590,2.050000:3272983.596,
#*# 	2.087500:3271916.687,2.125000:3270923.445,2.175000:3269732.770,
#*# 	2.212500:3268776.848,2.250000:3267836.388,2.287500:3266892.237,
#*# 	2.325000:3266012.258,2.375000:3264939.214,2.412500:3264026.616,
#*# 	2.450000:3263081.458,2.487500:3262173.273,2.525000:3261350.616,
#*# 	2.575000:3260402.501,2.612500:3259554.653,2.650000:3258733.656,
#*# 	2.687500:3257950.839,2.725000:3257174.412,2.775000:3256251.434,
#*# 	2.812500:3255482.741,2.850000:3254740.046,2.887500:3253996.628,
#*# 	2.925000:3253367.059,2.975000:3252509.462,3.012500:3251877.771,
#*# 	3.050000:3251278.693,3.087500:3250561.264,3.125000:3249958.581,
#*# 	3.175000:3249220.576,3.212500:3248571.820,3.250000:3247885.217,
#*# 	3.287500:3247250.483,3.325000:3246708.827,3.375000:3246084.865,
#*# 	3.412500:3245517.288,3.450000:3244982.387,3.487500:3244482.012,
#*# 	3.525000:3243943.857,3.575000:3243359.748,3.612500:3242828.173,
#*# 	3.650000:3242292.076,3.687500:3241795.739,3.725000:3241357.924,
#*# 	3.775000:3240822.934,3.812500:3240359.522,3.850000:3239956.341,
#*# 	3.887500:3239523.488,3.925000:3239110.790,3.975000:3238623.852,
#*# 	4.012500:3238142.722,4.050000:3237717.349
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.051693, 0.148706, 0.113715, 0.102298, 0.140588, 0.120475, 0.168795, 0.163764, 0.148799
#*# 	  0.083436, 0.146869, 0.130917, 0.094071, 0.122316, 0.098328, 0.145324, 0.156395, 0.135265
#*# 	  0.083146, 0.146684, 0.113036, 0.092140, 0.121643, 0.106164, 0.159286, 0.157420, 0.128122
#*# 	  0.090012, 0.161713, 0.138461, 0.098046, 0.122415, 0.099785, 0.137589, 0.140977, 0.117088
#*# 	  0.070421, 0.146684, 0.110711, 0.081603, 0.118545, 0.101332, 0.144063, 0.145905, 0.107711
#*# 	  0.072023, 0.146585, 0.134689, 0.090495, 0.107519, 0.088662, 0.124246, 0.134684, 0.105588
#*# 	  0.071164, 0.137200, 0.100361, 0.078501, 0.107618, 0.095811, 0.144749, 0.144063, 0.115646
#*# 	  0.097170, 0.147160, 0.130150, 0.088367, 0.110809, 0.083047, 0.126571, 0.137780, 0.113322
#*# 	  0.127339, 0.170005, 0.133719, 0.104810, 0.135528, 0.121736, 0.166375, 0.165904, 0.136729
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 205.0
#*# min_y = 21.42
#*# max_y = 198.53999999999996
