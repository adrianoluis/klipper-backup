# This file contains common pin mappings for the BIGTREETECH SKR mini
# E3 v3.0. To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication/USART.

# The "make flash" command does not work on the SKR mini E3. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the SKR
# mini E3 with that SD card.

# See docs/Config_Reference.md for a description of parameters.

[include mainsail.cfg]
[include macros/*.cfg]
[include autotune_tmc.cfg]
[include KAMP_Settings.cfg]

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_17004D001950425938323120-if00
restart_method: command

[include rpi.cfg]

[printer]
kinematics: corexz
max_velocity: 200
max_accel: 1000
max_z_velocity: 50
max_z_accel: 1000
square_corner_velocity: 4.0

[static_digital_output usb_pullup_enable]
pins: !PC13

[idle_timeout]
timeout: 1800

#  Enables support to exclude or cancel individual objects during the printing process.
[exclude_object]

[firmware_retraction]
retract_length: 1.5
retract_speed: 120
unretract_speed: 120

#####################################################################
#   X Stepper Settings
#####################################################################

######
# Motor -XM
# Endstop - X-STOP
###############
[stepper_x]
step_pin: PB13
dir_pin: PB12
enable_pin: !PB14
rotation_distance: 40
full_steps_per_rotation: 200
microsteps: 16
endstop_pin: ^toolhead:PB5
position_endstop: 220
position_min: 0
position_max: 220
homing_speed: 60
homing_retract_dist: 5
homing_positive_dir: True

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
uart_address: 0
run_current: 0.58
stealthchop_threshold: 999999

#####################################################################
#   Y Stepper Settings
#####################################################################

######
# Motor -YM
# Endstop - Y-STOP
###############
[stepper_y]
step_pin: PB10
dir_pin: PB2
enable_pin: !PB11
rotation_distance: 40
full_steps_per_rotation: 200
microsteps: 16
## Ucomment one of the following:
## Switch-based endstop for Y
endstop_pin: ^PC1 
## Sensorless endstop for Y
#endstop_pin: tmc2209_stepper_y:virtual_endstop
#homing_retract_dist: 0 # Uncomment this line too
position_endstop: 0
position_max: 220
homing_speed: 60
homing_positive_dir: False

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
run_current: 0.58
stealthchop_threshold: 999999
## Uncomment if using sensorless Y homing.
#driver_SGTHRS: 120 # tune this once it's working.

#####################################################################
#   Z Stepper Settings
#####################################################################

######
# Motor -ZAM
# Endstop - Z-STOP
###############
[stepper_z]
step_pin: PB0
dir_pin: PC5
enable_pin: !PB1
rotation_distance: 40
full_steps_per_rotation: 200
microsteps: 16
endstop_pin: probe:z_virtual_endstop
position_max: 215
homing_speed: 30
position_min: -3.0

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin: PC10
uart_address: 1
run_current: 0.58
stealthchop_threshold: 999999

#####################################################################
#   Extruder Settings
#####################################################################
[include toolhead.cfg]

#####################################################################
# 	Bed Heater
#####################################################################

######
# BED Connector
###############
[heater_bed]
heater_pin: PC9
##  Validate the following thermistor type to make sure it is correct
##  See https://www.klipper3d.org/Config_Reference.html#common-thermistors for additional options
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC4
min_temp: 0
max_temp: 130
#control: pid
#pid_Kp: 72.291
#pid_Ki: 1.381
#pid_Kd: 946.110

#####################################################################
# 	Fan Control
#####################################################################

######
# Electronics Fan
# FAN1 Connector
###############
[controller_fan my_controller_fan]
pin: PC7 
max_power: 1.00
kick_start_time: 0.200
heater: heater_bed
fan_speed: 0.60

#####################################################################
#   Temperature control
#####################################################################

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100 

#####################################################################
#   Homing and Bed Mesh
#####################################################################
[include eddy.cfg]

[screws_tilt_adjust]
screw1: 29, 2
screw1_name: Front left
screw2: 195, 2
screw2_name: Front right
screw3: 195, 182
screw3_name: Back right
screw4: 29, 182
screw4_name: Back left
screw_thread: CW-M4
horizontal_move_z: 20
speed: 50

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=,      EXP1_2=PB5,
    EXP1_3=PB8,   EXP1_4=PD6,
    EXP1_5=PB9,   EXP1_6=PA15,
    EXP1_7=,      EXP1_8=,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6,   EXP2_2=PA5,
    EXP2_3=PA10,  EXP2_4=,
    EXP2_5=PA9,   EXP2_6=PA7,
    EXP2_7=,      EXP2_8=,
    EXP2_9=<GND>, EXP2_10=

#####################################################################
#   Displays
#####################################################################
#  mini12864 LCD Display
[display]
lcd_type: uc1701
cs_pin: EXP1_3
a0_pin: EXP1_4
rst_pin: EXP1_5
encoder_pins: ^EXP2_5, ^EXP2_3
click_pin: ^!EXP1_2
contrast: 63
spi_software_miso_pin: EXP2_1
spi_software_mosi_pin: EXP2_6
spi_software_sclk_pin: EXP2_2

#  To control Neopixel RGB in mini12864 display
[neopixel fysetc_mini12864]
pin: EXP1_6
chain_count: 3
initial_RED: 0.1
initial_GREEN: 0.5
initial_BLUE: 0.0
color_order: RGB

##  Set RGB values on boot up for each Neopixel. 
##  Index 1 = display, Index 2 and 3 = Knob
[delayed_gcode welcome]
initial_duration: 1
gcode:
    SET_LED LED=fysetc_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
    SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
    SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3 

[include custom_lcd_menu.cfg]

#####################################################################
#   Case Lights
#####################################################################
;[output_pin LIGHTS]
;pin: PA8
;value: 0
;shutdown_value: 0

;[gcode_macro lights_on]
;gcode:
;    SET_PIN PIN=LIGHTS VALUE=1.0

;[gcode_macro lights_off]
;gcode:
;    SET_PIN PIN=LIGHTS VALUE=0.0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 27.405
#*# pid_ki = 3.447
#*# pid_kd = 54.466
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 71.982
#*# pid_ki = 1.300
#*# pid_kd = 996.044
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 16
#*# calibrate =
#*# 	0.050000:3352262.834,0.087500:3350279.912,0.125000:3348114.578,
#*# 	0.175000:3345442.740,0.212500:3343307.816,0.250000:3341244.573,
#*# 	0.287500:3339266.509,0.325000:3337247.820,0.375000:3334714.690,
#*# 	0.412500:3332572.715,0.450000:3330658.794,0.487500:3328925.652,
#*# 	0.525000:3327215.687,0.575000:3325098.768,0.612500:3323419.561,
#*# 	0.650000:3321732.736,0.687500:3320155.998,0.725000:3318568.850,
#*# 	0.775000:3316526.733,0.812500:3314793.069,0.850000:3313136.453,
#*# 	0.887500:3311663.030,0.925000:3310187.536,0.975000:3308358.561,
#*# 	1.012500:3306827.817,1.050000:3305377.956,1.087500:3303979.477,
#*# 	1.125000:3302508.738,1.175000:3300676.731,1.212500:3299156.915,
#*# 	1.250000:3297712.923,1.287500:3296364.092,1.325000:3294993.553,
#*# 	1.375000:3293363.426,1.412500:3292080.774,1.450000:3290723.864,
#*# 	1.487500:3289514.528,1.525000:3288202.062,1.575000:3286599.546,
#*# 	1.612500:3285246.192,1.650000:3283915.339,1.687500:3282759.697,
#*# 	1.725000:3281632.433,1.775000:3280273.294,1.812500:3279156.908,
#*# 	1.850000:3278014.793,1.887500:3276984.170,1.925000:3275911.786,
#*# 	1.975000:3274504.516,2.012500:3273375.029,2.050000:3272295.590,
#*# 	2.087500:3271290.656,2.125000:3270370.232,2.175000:3269194.190,
#*# 	2.212500:3268255.218,2.250000:3267295.318,2.287500:3266405.427,
#*# 	2.325000:3265472.694,2.375000:3264375.431,2.412500:3263415.219,
#*# 	2.450000:3262520.228,2.487500:3261681.105,2.525000:3260893.310,
#*# 	2.575000:3259864.802,2.612500:3259065.104,2.650000:3258279.673,
#*# 	2.687500:3257506.421,2.725000:3256773.386,2.775000:3255837.879,
#*# 	2.812500:3254985.062,2.850000:3254267.432,2.887500:3253581.074,
#*# 	2.925000:3252916.855,2.975000:3252106.510,3.012500:3251485.715,
#*# 	3.050000:3250847.914,3.087500:3250246.446,3.125000:3249623.267,
#*# 	3.175000:3248860.911,3.212500:3248208.654,3.250000:3247567.332,
#*# 	3.287500:3247025.779,3.325000:3246442.062,3.375000:3245766.116,
#*# 	3.412500:3245225.085,3.450000:3244699.625,3.487500:3244183.486,
#*# 	3.525000:3243677.462,3.575000:3243044.951,3.612500:3242491.420,
#*# 	3.650000:3242025.815,3.687500:3241546.125,3.725000:3241100.801,
#*# 	3.775000:3240574.129,3.812500:3240138.077,3.850000:3239704.161,
#*# 	3.887500:3239311.662,3.925000:3238869.050,3.975000:3238330.729,
#*# 	4.012500:3237876.062,4.050000:3237458.274
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.049470, 0.150258, 0.118042, 0.119363, 0.146111, 0.144992, 0.194009, 0.195042, 0.186242
#*# 	  0.090221, 0.131066, 0.131362, 0.100324, 0.120887, 0.113966, 0.154298, 0.177065, 0.163016
#*# 	  0.081157, 0.134314, 0.105206, 0.089047, 0.116411, 0.115192, 0.172199, 0.173859, 0.148960
#*# 	  0.093868, 0.146220, 0.135029, 0.095333, 0.119363, 0.108143, 0.143775, 0.161918, 0.136760
#*# 	  0.074901, 0.143873, 0.109250, 0.088490, 0.114783, 0.108730, 0.159810, 0.165743, 0.126482
#*# 	  0.078327, 0.135439, 0.135123, 0.094455, 0.105345, 0.098075, 0.132486, 0.155672, 0.130144
#*# 	  0.083994, 0.138185, 0.105698, 0.085753, 0.112545, 0.109904, 0.160451, 0.165224, 0.134419
#*# 	  0.115291, 0.152003, 0.146220, 0.104135, 0.123124, 0.110881, 0.145401, 0.170819, 0.144380
#*# 	  0.159712, 0.187804, 0.153382, 0.131973, 0.156312, 0.151357, 0.200400, 0.206123, 0.174676
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 205.0
#*# min_y = 21.42
#*# max_y = 198.53999999999996
