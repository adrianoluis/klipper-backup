# This file contains common pin mappings for the BIGTREETECH SKR mini
# E3 v3.0. To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication/USART.

# The "make flash" command does not work on the SKR mini E3. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the SKR
# mini E3 with that SD card.

# See docs/Config_Reference.md for a description of parameters.

[include mainsail.cfg]
[include macros/*.cfg]
[include autotune_tmc.cfg]
[include KAMP_Settings.cfg]

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_17004D001950425938323120-if00
;serial: /dev/ttyAMA0
restart_method: command

[include rpi.cfg]

[printer]
kinematics: corexz
max_velocity: 500
max_accel: 3000
max_z_velocity: 50
max_z_accel: 1000
square_corner_velocity: 8.0

[static_digital_output usb_pullup_enable]
pins: !PA14

[idle_timeout]
timeout: 1800

#  Enables support to exclude or cancel individual objects during the printing process.
[exclude_object]

[firmware_retraction]
retract_length: 1.5
;unretract_extra_length: 0
retract_speed: 120
unretract_speed: 120

#####################################################################
#   X Stepper Settings
#####################################################################

######
# Motor -XM
# Endstop - X-STOP
###############
[stepper_x]
step_pin: PB13
dir_pin: PB12
enable_pin: !PB14
rotation_distance: 40
full_steps_per_rotation: 200
microsteps: 32
endstop_pin: ^toolhead:PB5
position_endstop: 220
position_min: 0
position_max: 220
homing_speed: 60
homing_retract_dist: 5
homing_positive_dir: True

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
diag_pin: PC0
uart_address: 0
run_current: 0.5
;hold_current: 0.3
interpolate: True
stealthchop_threshold: 250

#####################################################################
#   Y Stepper Settings
#####################################################################

######
# Motor -YM
# Endstop - Y-STOP
###############
[stepper_y]
step_pin: PB10
dir_pin: PB2
enable_pin: !PB11
rotation_distance: 40
full_steps_per_rotation: 200
microsteps: 32
endstop_pin: ^PC1
position_endstop: 0
position_min: 0
position_max: 220
homing_speed: 60
homing_retract_dist: 5
homing_positive_dir: False

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
run_current: 0.5
;hold_current: 0.3
interpolate: True
stealthchop_threshold: 250

#####################################################################
#   Z Stepper Settings
#####################################################################

######
# Motor -ZAM
# Endstop - Z-STOP
###############
[stepper_z]
step_pin: PB0
dir_pin: PC5
enable_pin: !PB1
rotation_distance: 40
full_steps_per_rotation: 200
microsteps: 32
endstop_pin: probe:z_virtual_endstop
;endstop_pin: ^PC2
position_max: 210
position_min: -5
homing_speed: 20

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin: PC10
uart_address: 1
run_current: 0.5
;hold_current: 0.3
interpolate: True
stealthchop_threshold: 250

#####################################################################
#   Extruder Settings
#####################################################################
[include toolhead.cfg]

#####################################################################
# 	Bed Heater
#####################################################################

######
# BED Connector
###############
[heater_bed]
heater_pin: PC9
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC4
#control: pid
#pid_Kp: 72.291
#pid_Ki: 1.381
#pid_Kd: 946.110
min_temp: 0
max_temp: 130

#####################################################################
# 	Fan Control
#####################################################################

######
# Electronics Fan
# FAN1 Connector
###############
[controller_fan controller_fan]
pin: PC7
max_power: 1.00
kick_start_time: 0.200
heater: heater_bed
fan_speed: 0.60

######
# Hot End Fan
# FAN2 Connector
###############
[heater_fan hotend_fan]
pin: toolhead:PA0
heater: extruder
heater_temp: 50.0
##  If you are experiencing back flow, you can reduce fan_speed
;fan_speed: 1.0

######
# Part Cooling Fan
# FAN0 Connector
###############
[fan]
pin: toolhead:PA1
;cycle_time: .08
##	Depending on your fan, you may need to increase this value
##	if your fan will not start. Can change cycle_time (increase)
##	if your fan is not able to slow down effectively
kick_start_time: .25

#####################################################################
#   Temperature control
#####################################################################

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100 

#####################################################################
#   Homing and Bed Mesh
#####################################################################
[include eddy.cfg]

[screws_tilt_adjust]
screw1: 29, 2
screw1_name: Front left
screw2: 195, 2
screw2_name: Front right
screw3: 195, 182
screw3_name: Back right
screw4: 29, 182
screw4_name: Back left
screw_thread: CW-M4
horizontal_move_z: 20

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=,      EXP1_2=PB5,
    EXP1_3=PB8,   EXP1_4=PD6,
    EXP1_5=PB9,   EXP1_6=PA15,
    EXP1_7=,      EXP1_8=,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6,   EXP2_2=PA5,
    EXP2_3=PA10,  EXP2_4=,
    EXP2_5=PA9,   EXP2_6=PA7,
    EXP2_7=,      EXP2_8=,
    EXP2_9=<GND>, EXP2_10=

#####################################################################
#   Displays
#####################################################################
#  mini12864 LCD Display
[display]
lcd_type: uc1701
cs_pin: EXP1_3
a0_pin: EXP1_4
rst_pin: EXP1_5
encoder_pins: ^EXP2_5, ^EXP2_3
click_pin: ^!EXP1_2
contrast: 63
spi_software_miso_pin: EXP2_1
spi_software_mosi_pin: EXP2_6
spi_software_sclk_pin: EXP2_2

#  To control Neopixel RGB in mini12864 display
[neopixel fysetc_mini12864]
pin: EXP1_6
chain_count: 3
initial_RED: 0.1
initial_GREEN: 0.5
initial_BLUE: 0.0
color_order: RGB

##  Set RGB values on boot up for each Neopixel. 
##  Index 1 = display, Index 2 and 3 = Knob
[delayed_gcode welcome]
initial_duration: 1
gcode:
    SET_LED LED=fysetc_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
    SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
    SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3 

[include custom_lcd_menu.cfg]

#####################################################################
#   Case Lights
#####################################################################
;[output_pin LIGHTS]
;pin: PA8
;value: 0
;shutdown_value: 0

;[gcode_macro lights_on]
;gcode:
;    SET_PIN PIN=LIGHTS VALUE=1.0

;[gcode_macro lights_off]
;gcode:
;    SET_PIN PIN=LIGHTS VALUE=0.0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 27.122
#*# pid_ki = 3.348
#*# pid_kd = 54.921
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 72.293
#*# pid_ki = 1.393
#*# pid_kd = 938.000
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 16
#*# calibrate =
#*# 	0.050000:3331353.795,0.087500:3329863.644,0.131250:3327942.975,
#*# 	0.168750:3326030.914,0.212500:3324030.139,0.250000:3322454.177,
#*# 	0.287500:3321093.478,0.331250:3319416.793,0.368750:3317675.099,
#*# 	0.412500:3315705.238,0.450000:3314215.699,0.487500:3312840.319,
#*# 	0.531250:3311255.120,0.568750:3309644.025,0.612500:3307845.928,
#*# 	0.650000:3306482.161,0.687500:3305239.844,0.731250:3303783.385,
#*# 	0.768750:3302311.331,0.812500:3300593.194,0.850000:3299272.453,
#*# 	0.887500:3298134.647,0.931250:3296754.500,0.968750:3295368.042,
#*# 	1.012500:3293843.438,1.050000:3292638.250,1.087500:3291604.591,
#*# 	1.131250:3290318.446,1.168750:3289057.359,1.212500:3287510.399,
#*# 	1.250000:3286307.654,1.287500:3285315.358,1.331250:3284059.398,
#*# 	1.368750:3282803.925,1.412500:3281453.980,1.450000:3280423.273,
#*# 	1.487500:3279411.478,1.531250:3278291.674,1.568750:3277074.387,
#*# 	1.612500:3275790.151,1.650000:3274772.517,1.687500:3273930.166,
#*# 	1.731250:3272882.500,1.768750:3271786.917,1.812500:3270642.942,
#*# 	1.850000:3269795.383,1.887500:3268964.283,1.931250:3268008.313,
#*# 	1.968750:3267031.590,2.012500:3265827.617,2.050000:3265206.968,
#*# 	2.087500:3264141.556,2.131250:3263568.903,2.168750:3262667.173,
#*# 	2.212500:3261691.861,2.250000:3260880.364,2.287500:3260150.598,
#*# 	2.331250:3259360.292,2.368750:3258453.058,2.412500:3257527.143,
#*# 	2.450000:3256853.448,2.487500:3256207.339,2.531250:3255495.402,
#*# 	2.568750:3254775.762,2.612500:3254031.638,2.650000:3253386.582,
#*# 	2.687500:3252854.719,2.731250:3252198.855,2.768750:3251546.940,
#*# 	2.812500:3250827.489,2.850000:3250217.313,2.887500:3249681.575,
#*# 	2.931250:3249105.654,2.968750:3248488.414,3.012500:3247806.164,
#*# 	3.050000:3247254.079,3.087500:3246759.820,3.131250:3246219.460,
#*# 	3.168750:3245661.442,3.212500:3244997.365,3.250000:3244533.688,
#*# 	3.287500:3244071.506,3.331250:3243571.463,3.368750:3243067.145,
#*# 	3.412500:3242515.113,3.450000:3242058.076,3.487500:3241678.989,
#*# 	3.531250:3241225.745,3.568750:3240745.248,3.612500:3240226.405,
#*# 	3.650000:3239813.887,3.687500:3239474.766,3.731250:3239061.967,
#*# 	3.768750:3238640.884,3.812500:3238200.193,3.850000:3237842.646,
#*# 	3.887500:3237550.748,3.931250:3237169.365,3.968750:3236774.701,
#*# 	4.012500:3236322.787,4.050000:3235963.008
#*#
#*# [bed_mesh 2024-02-01_Cold ]
#*# version = 1
#*# points =
#*# 	0.165534, 0.163494, 0.132519, 0.110718, 0.149185, 0.172789, 0.227778, 0.294625, 0.359611
#*# 	0.218682, 0.168326, 0.151127, 0.121365, 0.152775, 0.164626, 0.194275, 0.264947, 0.350506
#*# 	0.211967, 0.167430, 0.124768, 0.102637, 0.131354, 0.155332, 0.200999, 0.264462, 0.323240
#*# 	0.220693, 0.180682, 0.146818, 0.109260, 0.127782, 0.143929, 0.169480, 0.237323, 0.307371
#*# 	0.211366, 0.180177, 0.133569, 0.097995, 0.124122, 0.137647, 0.181197, 0.243068, 0.290258
#*# 	0.204547, 0.167183, 0.139357, 0.098136, 0.110053, 0.124122, 0.145004, 0.208534, 0.275612
#*# 	0.217393, 0.171129, 0.124336, 0.088979, 0.118347, 0.131479, 0.173933, 0.229543, 0.275052
#*# 	0.246313, 0.189679, 0.165400, 0.130822, 0.147349, 0.150880, 0.174561, 0.236963, 0.302444
#*# 	0.280191, 0.225299, 0.188973, 0.152910, 0.183619, 0.191567, 0.236945, 0.295629, 0.338020
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 205.0
#*# min_y = 21.42
#*# max_y = 198.53999999999996
