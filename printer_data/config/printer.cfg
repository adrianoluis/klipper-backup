# This file contains common pin mappings for the BIGTREETECH SKR mini
# E3 v3.0. To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication/USART.

# The "make flash" command does not work on the SKR mini E3. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the SKR
# mini E3 with that SD card.

# See docs/Config_Reference.md for a description of parameters.

[include mainsail.cfg]
[include macros/*.cfg]
[include autotune_tmc.cfg]
[include KAMP_Settings.cfg]

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_17004D001950425938323120-if00
;serial: /dev/ttyAMA0
restart_method: command

[printer]
kinematics: corexz
max_velocity: 500
max_accel: 3000
max_z_velocity: 50
max_z_accel: 500
square_corner_velocity: 4.0

[static_digital_output usb_pullup_enable]
pins: !PA14

[idle_timeout]
timeout: 1800

#  Enables support to exclude or cancel individual objects during the printing process.
[exclude_object]

;[firmware_retraction]
;retract_length: 5
;unretract_extra_length: 0
;retract_speed: 120
;unretract_speed: 120

#####################################################################
#   X Stepper Settings
#####################################################################

######
# Motor -XM
# Endstop - X-STOP
###############
[stepper_x]
step_pin: PB13
dir_pin: PB12
enable_pin: !PB14
rotation_distance: 40
full_steps_per_rotation: 200
microsteps: 32
endstop_pin: ^toolhead:PB5
position_endstop: 220
position_min: 0
position_max: 220
homing_speed: 60
homing_retract_dist: 5
homing_positive_dir: True

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
diag_pin: PC0
uart_address: 0
run_current: 0.5
;hold_current: 0.3
interpolate: True
stealthchop_threshold: 250

#####################################################################
#   Y Stepper Settings
#####################################################################

######
# Motor -YM
# Endstop - Y-STOP
###############
[stepper_y]
step_pin: PB10
dir_pin: PB2
enable_pin: !PB11
rotation_distance: 40
full_steps_per_rotation: 200
microsteps: 32
endstop_pin: ^PC1
position_endstop: 0
position_min: 0
position_max: 220
homing_speed: 60
homing_retract_dist: 5
homing_positive_dir: False

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
run_current: 0.5
;hold_current: 0.3
interpolate: True
stealthchop_threshold: 250

#####################################################################
#   Z Stepper Settings
#####################################################################

######
# Motor -ZAM
# Endstop - Z-STOP
###############
[stepper_z]
step_pin: PB0
dir_pin: PC5
enable_pin: !PB1
rotation_distance: 40
full_steps_per_rotation: 200
microsteps: 32
endstop_pin: probe:z_virtual_endstop
;endstop_pin: ^PC2
position_max: 210
;position_min: 0
homing_speed: 20

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin: PC10
uart_address: 1
run_current: 0.5
;hold_current: 0.3
interpolate: True
stealthchop_threshold: 250

#####################################################################
#   Extruder Settings
#####################################################################
[include toolhead.cfg]

#####################################################################
# 	Bed Heater
#####################################################################

######
# BED Connector
###############
[heater_bed]
heater_pin: PC9
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC4
#control: pid
#pid_Kp: 72.291
#pid_Ki: 1.381
#pid_Kd: 946.110
min_temp: 0
max_temp: 130

#####################################################################
# 	Fan Control
#####################################################################

######
# Electronics Fan
# FAN1 Connector
###############
[controller_fan controller_fan]
pin: PC7
max_power: 1.00
kick_start_time: 0.200
heater: heater_bed
fan_speed: 0.60

######
# Hot End Fan
# FAN2 Connector
###############
[heater_fan hotend_fan]
pin: toolhead:PA0
heater: extruder
heater_temp: 50.0
##  If you are experiencing back flow, you can reduce fan_speed
;fan_speed: 1.0

######
# Part Cooling Fan
# FAN0 Connector
###############
[fan]
pin: toolhead:PA1
;cycle_time: .08
##	Depending on your fan, you may need to increase this value
##	if your fan will not start. Can change cycle_time (increase)
##	if your fan is not able to slow down effectively
kick_start_time: .25

#####################################################################
#   Temperature control
#####################################################################

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100 

#####################################################################
#   Homing and Bed Mesh
#####################################################################
[include eddy.cfg]

[screws_tilt_adjust]
screw1: 29, 2
screw1_name: Front left
screw2: 195, 2
screw2_name: Front right
screw3: 195, 182
screw3_name: Back right
screw4: 29, 182
screw4_name: Back left
screw_thread: CW-M4
horizontal_move_z: 20

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=,      EXP1_2=PB5,
    EXP1_3=PB8,   EXP1_4=PD6,
    EXP1_5=PB9,   EXP1_6=PA15,
    EXP1_7=,      EXP1_8=,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6,   EXP2_2=PA5,
    EXP2_3=PA10,  EXP2_4=,
    EXP2_5=PA9,   EXP2_6=PA7,
    EXP2_7=,      EXP2_8=,
    EXP2_9=<GND>, EXP2_10=

#####################################################################
#   Displays
#####################################################################
#  mini12864 LCD Display
[display]
lcd_type: uc1701
cs_pin: EXP1_3
a0_pin: EXP1_4
rst_pin: EXP1_5
encoder_pins: ^EXP2_5, ^EXP2_3
click_pin: ^!EXP1_2
contrast: 63
spi_software_miso_pin: EXP2_1
spi_software_mosi_pin: EXP2_6
spi_software_sclk_pin: EXP2_2

#  To control Neopixel RGB in mini12864 display
[neopixel fysetc_mini12864]
pin: EXP1_6
chain_count: 3
initial_RED: 0.1
initial_GREEN: 0.5
initial_BLUE: 0.0
color_order: RGB

##  Set RGB values on boot up for each Neopixel. 
##  Index 1 = display, Index 2 and 3 = Knob
[delayed_gcode welcome]
initial_duration: 1
gcode:
    SET_LED LED=fysetc_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
    SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
    SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3 

[include custom_lcd_menu.cfg]

#####################################################################
#   Case Lights
#####################################################################
;[output_pin LIGHTS]
;pin: PA8
;value: 0
;shutdown_value: 0

;[gcode_macro lights_on]
;gcode:
;    SET_PIN PIN=LIGHTS VALUE=1.0

;[gcode_macro lights_off]
;gcode:
;    SET_PIN PIN=LIGHTS VALUE=0.0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 27.122
#*# pid_ki = 3.348
#*# pid_kd = 54.921
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 72.293
#*# pid_ki = 1.393
#*# pid_kd = 938.000
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 16
#*# calibrate =
#*# 	0.050000:3323085.677,0.087500:3321530.951,0.131250:3319716.480,
#*# 	0.168750:3318195.112,0.212500:3316360.145,0.250000:3314798.918,
#*# 	0.287500:3313384.806,0.331250:3311810.058,0.368750:3310427.799,
#*# 	0.412500:3308732.878,0.450000:3307139.347,0.487500:3305589.854,
#*# 	0.531250:3304006.861,0.568750:3302586.384,0.612500:3301037.922,
#*# 	0.650000:3299589.798,0.687500:3298265.940,0.731250:3296875.484,
#*# 	0.768750:3295605.961,0.812500:3294033.825,0.850000:3292695.737,
#*# 	0.887500:3291298.236,0.931250:3289878.604,0.968750:3288641.684,
#*# 	1.012500:3287218.262,1.050000:3285910.769,1.087500:3284756.268,
#*# 	1.131250:3283548.358,1.168750:3282426.056,1.212500:3281069.161,
#*# 	1.250000:3279893.488,1.287500:3278652.590,1.331250:3277414.113,
#*# 	1.368750:3276255.209,1.412500:3274997.963,1.450000:3273871.720,
#*# 	1.487500:3272784.979,1.531250:3271764.135,1.568750:3270818.904,
#*# 	1.612500:3269663.016,1.650000:3268665.440,1.687500:3267613.283,
#*# 	1.731250:3266519.562,1.768750:3265646.820,1.812500:3264609.450,
#*# 	1.850000:3263786.569,1.887500:3262987.763,1.931250:3262064.757,
#*# 	1.968750:3261227.865,2.012500:3260296.421,2.050000:3259451.639,
#*# 	2.087500:3258578.732,2.131250:3257692.046,2.168750:3256960.718,
#*# 	2.212500:3256088.060,2.250000:3255337.449,2.287500:3254618.522,
#*# 	2.331250:3253879.574,2.368750:3253205.849,2.412500:3252420.790,
#*# 	2.450000:3251725.127,2.487500:3251022.050,2.531250:3250322.496,
#*# 	2.568750:3249640.029,2.612500:3248868.924,2.650000:3248271.990,
#*# 	2.687500:3247720.959,2.731250:3247148.791,2.768750:3246626.959,
#*# 	2.812500:3246034.491,2.850000:3245457.575,2.887500:3244924.664,
#*# 	2.931250:3244299.454,2.968750:3243815.775,3.012500:3243257.080,
#*# 	3.050000:3242734.276,3.087500:3242288.207,3.131250:3241746.690,
#*# 	3.168750:3241336.802,3.212500:3240802.238,3.250000:3240340.143,
#*# 	3.287500:3239832.530,3.331250:3239339.809,3.368750:3238893.386,
#*# 	3.412500:3238408.800,3.450000:3238012.753,3.487500:3237609.896,
#*# 	3.531250:3237171.789,3.568750:3236846.543,3.612500:3236374.308,
#*# 	3.650000:3235988.227,3.687500:3235594.778,3.731250:3235152.266,
#*# 	3.768750:3234804.988,3.812500:3234431.736,3.850000:3234066.263,
#*# 	3.887500:3233754.788,3.931250:3233388.670,3.968750:3233101.465,
#*# 	4.012500:3232704.595,4.050000:3232368.854
#*#
#*# [bed_mesh 2024-01-31_Cold]
#*# version = 1
#*# points =
#*# 	  0.417366, 0.347190, 0.300184, 0.274830, 0.310095, 0.330316, 0.385181, 0.443649, 0.550425
#*# 	  0.446906, 0.442469, 0.418932, 0.392684, 0.417725, 0.436450, 0.461063, 0.532122, 0.539775
#*# 	  0.424217, 0.340589, 0.297783, 0.274568, 0.303927, 0.320778, 0.373390, 0.427936, 0.521126
#*# 	  0.436825, 0.445488, 0.412913, 0.376012, 0.397257, 0.414838, 0.440773, 0.505983, 0.501593
#*# 	  0.414365, 0.337007, 0.296527, 0.267302, 0.291747, 0.305073, 0.341039, 0.407055, 0.480949
#*# 	  0.418574, 0.424707, 0.400965, 0.355616, 0.372284, 0.392293, 0.412301, 0.475339, 0.471393
#*# 	  0.416159, 0.321042, 0.278213, 0.247944, 0.274676, 0.289546, 0.324853, 0.389147, 0.467787
#*# 	  0.450040, 0.436467, 0.411869, 0.377269, 0.398061, 0.409527, 0.434667, 0.496191, 0.492518
#*# 	  0.467416, 0.361947, 0.327078, 0.297650, 0.323157, 0.338876, 0.385811, 0.438636, 0.528081
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 205.0
#*# min_y = 21.42
#*# max_y = 198.53999999999996
